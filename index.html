<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The HIVE MC Status | Ultimate</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;800&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
    <style>
        :root {
            /* テーマカラー定義 */
            --bg-dark: #0f172a;
            --bg-card: rgba(30, 41, 59, 0.7);
            --bg-input: rgba(15, 23, 42, 0.8);
            
            --accent-yellow: #fbbf24; /* Hive Yellow */
            --accent-purple: #8b5cf6; /* Hive Purple */
            --accent-cyan: #22d3ee;
            --accent-rose: #f43f5e;
            
            --text-main: #f1f5f9;
            --text-sub: #94a3b8;
            
            --glass-border: 1px solid rgba(255, 255, 255, 0.1);
            --shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }

        * { box-sizing: border-box; outline: none; }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-dark);
            /* 背景に動的なグラデーション */
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(139, 92, 246, 0.15) 0%, transparent 40%),
                radial-gradient(circle at 90% 80%, rgba(251, 191, 36, 0.1) 0%, transparent 40%);
            color: var(--text-main);
            margin: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
        }

        /* --- ヘッダーエリア --- */
        .header-container {
            text-align: center;
            margin: 40px 0 30px;
            width: 100%;
            max-width: 700px;
            animation: fadeInDown 0.8s ease;
        }

        h1 {
            font-size: 3rem;
            font-weight: 800;
            margin: 0;
            letter-spacing: -1px;
            background: linear-gradient(135deg, #fff 0%, var(--accent-yellow) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .subtitle {
            color: var(--text-sub);
            font-size: 0.9rem;
            margin-top: 10px;
            letter-spacing: 2px;
            text-transform: uppercase;
        }

        /* --- 検索ボックス --- */
        .search-wrapper {
            position: relative;
            margin-top: 30px;
            display: flex;
            gap: 12px;
        }

        input {
            width: 100%;
            padding: 16px 24px;
            border-radius: 16px;
            background: var(--bg-input);
            border: var(--glass-border);
            color: #fff;
            font-size: 1.1rem;
            transition: 0.3s;
            backdrop-filter: blur(4px);
        }

        input:focus {
            border-color: var(--accent-purple);
            box-shadow: 0 0 0 4px rgba(139, 92, 246, 0.1);
        }

        .search-btn {
            padding: 0 32px;
            border-radius: 16px;
            border: none;
            background: linear-gradient(135deg, var(--accent-yellow), #f59e0b);
            color: #0f172a;
            font-weight: 700;
            font-size: 1rem;
            cursor: pointer;
            transition: 0.3s;
        }

        .search-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 20px rgba(251, 191, 36, 0.4);
        }

        /* --- メインダッシュボード --- */
        #dashboard {
            display: none;
            width: 100%;
            max-width: 1000px;
            animation: slideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1);
        }

        /* プロフィールカード */
        .profile-card {
            background: var(--bg-card);
            backdrop-filter: blur(12px);
            border: var(--glass-border);
            border-radius: 24px;
            padding: 30px;
            display: flex;
            align-items: center;
            gap: 30px;
            margin-bottom: 30px;
            box-shadow: var(--shadow);
            position: relative;
            overflow: hidden;
        }

        /* 背景装飾 */
        .profile-card::before {
            content: '';
            position: absolute;
            top: 0; right: 0; width: 200px; height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.03));
            transform: skewX(-20deg);
        }

        .avatar-frame {
            position: relative;
            width: 100px;
            height: 100px;
            flex-shrink: 0;
        }

        .avatar {
            width: 100%;
            height: 100%;
            border-radius: 20px;
            border: 2px solid var(--accent-purple);
            object-fit: cover;
            background: #000;
        }

        .player-details h2 {
            margin: 0;
            font-size: 2.2rem;
            color: #fff;
        }

        .badges {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .badge {
            padding: 6px 12px;
            border-radius: 8px;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .badge-rank { background: rgba(139, 92, 246, 0.2); color: var(--accent-purple); }
        .badge-date { background: rgba(34, 211, 238, 0.2); color: var(--accent-cyan); }

        /* ナビゲーションタブ */
        .nav-tabs {
            display: flex;
            gap: 10px;
            overflow-x: auto;
            padding-bottom: 10px;
            margin-bottom: 20px;
            -webkit-overflow-scrolling: touch;
        }
        
        .nav-tabs::-webkit-scrollbar { height: 4px; }
        .nav-tabs::-webkit-scrollbar-thumb { background: var(--accent-purple); border-radius: 4px; }

        .tab-btn {
            background: rgba(30, 41, 59, 0.5);
            border: 1px solid transparent;
            color: var(--text-sub);
            padding: 12px 20px;
            border-radius: 12px;
            cursor: pointer;
            white-space: nowrap;
            font-weight: 600;
            font-size: 0.9rem;
            transition: 0.3s;
        }

        .tab-btn:hover { background: rgba(255,255,255,0.05); color: #fff; }
        .tab-btn.active {
            background: rgba(139, 92, 246, 0.15);
            border-color: var(--accent-purple);
            color: var(--accent-purple);
        }

        /* 統計グリッド */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(220px, 1fr));
            gap: 20px;
        }

        .stat-card {
            background: var(--bg-card);
            border: var(--glass-border);
            border-radius: 16px;
            padding: 24px;
            transition: 0.3s;
            position: relative;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            background: rgba(40, 50, 70, 0.8);
            border-color: rgba(255,255,255,0.2);
        }

        .stat-card.featured {
            grid-column: span 2;
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.9), rgba(15, 23, 42, 0.9));
            border: 1px solid var(--accent-yellow);
        }
        @media (max-width: 600px) { .stat-card.featured { grid-column: span 1; } }

        .label {
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-sub);
            margin-bottom: 8px;
            display: block;
        }

        .value {
            font-family: 'JetBrains Mono', monospace;
            font-size: 1.8rem;
            font-weight: 700;
            color: #fff;
        }
        
        .value.highlight { color: var(--accent-yellow); }
        .value.win { color: var(--accent-cyan); }
        .value.kill { color: var(--accent-rose); }

        .sub-value {
            font-size: 0.85rem;
            color: var(--text-sub);
            margin-top: 6px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        /* ローディング */
        .loader {
            display: none;
            width: 48px; height: 48px;
            border: 5px solid #FFF;
            border-bottom-color: var(--accent-purple);
            border-radius: 50%;
            animation: rotation 1s linear infinite;
            margin: 50px auto;
        }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        @keyframes fadeInDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes slideUp { from { opacity: 0; transform: translateY(40px); } to { opacity: 1; transform: translateY(0); } }

        /* フッター */
        .footer {
            margin-top: auto;
            padding: 40px 0 20px;
            color: var(--text-sub);
            font-size: 0.8rem;
            text-align: center;
        }
    </style>
</head>
<body>

    <div class="header-container">
        <h1>HIVE <span>ANALYTICS</span></h1>
        <div class="subtitle">Professional Stats Tracker</div>
        
        <div class="search-wrapper">
            <input type="text" id="username" placeholder="Gamertagを入力 (例: steve)" onkeypress="if(event.key==='Enter') search()">
            <button class="search-btn" onclick="search()">分析開始</button>
        </div>
    </div>

    <div class="loader" id="loader"></div>

    <div id="dashboard">
        <div class="profile-card">
            <div class="avatar-frame">
                <img id="userAvatar" src="" alt="Avatar" class="avatar" onerror="this.src='https://playhive.com/static/img/hive-logo.png'">
            </div>
            <div class="player-details">
                <h2 id="displayId">Username</h2>
                <div class="badges">
                    <span class="badge badge-rank" id="totalLevel">LVL FETCHING...</span>
                    <span class="badge badge-date" id="firstPlayed">初参加: ---</span>
                </div>
            </div>
        </div>

        <div class="nav-tabs" id="tabsContainer">
            </div>

        <div id="statsContent" class="stats-grid">
            </div>
    </div>

    <div class="footer">
        Powered by The Hive API & SK0528JP Logic<br>
        Unofficial Tool for Educational Purpose
    </div>

    <script>
        // --- 設定: APIエンドポイントと日本語名のマッピング ---
        const GAMES = {
            wars:   { name: "Treasure Wars",  endpoint: "wars" },
            sky:    { name: "SkyWars",        endpoint: "sky" },
            sg:     { name: "Survival Games", endpoint: "sg" },
            dr:     { name: "DeathRun",       endpoint: "dr" },
            hide:   { name: "Hide & Seek",    endpoint: "hide" },
            murder: { name: "Murder Mystery", endpoint: "murder" },
            ctf:    { name: "Capture The Flag", endpoint: "ctf" }, // APIがあれば
            drop:   { name: "Block Drop",     endpoint: "drop" },   // APIがあれば
            build:  { name: "Just Build",     endpoint: "build" },
            ground: { name: "Ground Wars",    endpoint: "ground" }
        };

        // 状態管理
        let playerData = {};
        let currentTab = 'wars';

        // --- メイン関数: データ取得 ---
        async function search() {
            const rawInput = document.getElementById('username').value.trim();
            if (!rawInput) return;
            
            // BEプレイヤー向け: スペースがあってもURLエンコードで対応
            const username = encodeURIComponent(rawInput);

            // UIリセット
            document.getElementById('dashboard').style.display = 'none';
            document.getElementById('loader').style.display = 'block';

            try {
                // 全ゲームのAPIを並列で叩く (高速化)
                const promises = Object.keys(GAMES).map(key => 
                    fetch(`https://api.playhive.com/v0/game/all/${GAMES[key].endpoint}/${username}`)
                        .then(res => {
                            if (!res.ok) return null; // 404ならnullを返す
                            return res.json();
                        })
                        .catch(() => null)
                );

                const results = await Promise.all(promises);

                // データ整理
                playerData = {};
                let hasData = false;
                let firstPlayedTimestamp = Infinity;
                let totalXP = 0;

                Object.keys(GAMES).forEach((key, index) => {
                    const data = results[index];
                    if (data) {
                        playerData[key] = data;
                        hasData = true;
                        
                        // 初参加日の最小値を探す
                        if (data.first_played && data.first_played < firstPlayedTimestamp) {
                            firstPlayedTimestamp = data.first_played;
                        }
                        // XP合算
                        if (data.xp) totalXP += data.xp;
                    } else {
                        playerData[key] = null;
                    }
                });

                if (!hasData) {
                    throw new Error("No Data Found");
                }

                // --- プロフィール更新 ---
                document.getElementById('displayId').innerText = decodeURIComponent(username);
                
                // 初参加日
                if(firstPlayedTimestamp !== Infinity) {
                    const date = new Date(firstPlayedTimestamp * 1000);
                    document.getElementById('firstPlayed').innerText = `初参加: ${date.getFullYear()}/${date.getMonth()+1}/${date.getDate()}`;
                }

                // 総合レベル推計 (簡易表示)
                document.getElementById('totalLevel').innerText = `TOTAL XP: ${(totalXP/1000).toFixed(1)}k`;

                // アイコン取得ロジック (統合版対応)
                // 1. まずBedrock向けのスキン取得を試みる (TydiumCraftなどのAPIが優秀だが、ここでは汎用的なGeyserスキンAPIを使用)
                // 2. 失敗時はHTML側のonerrorでHiveロゴへ
                // ※Java版IDならこれで正しく出る。BE版ID(スペース入り)もエンコードされれば対応するAPIを使用
                const cleanName = rawInput.replace(/ /g, '%20'); 
                // Geyser API等を使うのが確実だが、ここではBE対応しているAPIの一例として
                // TydiumCraftやCraftheadがある。今回は汎用性重視で `https://api.tydiumcraft.net/v1/players/skin?name=` を使う手もあるが、
                // 最も安定しているのは「名前からXUIDを引いて画像を出す」こと。
                // 簡易実装として、まずはMinotar(Java)を試し、だめならデフォルトへ倒す。
                // ★BE対応のためのURL生成★
                // 実際にはHive APIに avatar_url があればそれが最強。
                let avatarUrl = `https://ssl.gstatic.com/images/branding/product/1x/avatar_circle_blue_512dp.png`; // 仮
                
                // 特定のゲームデータにアバター情報が含まれているかチェック
                const anyGameData = Object.values(playerData).find(d => d && d.avatar_url);
                if (anyGameData && anyGameData.avatar_url) {
                    avatarUrl = anyGameData.avatar_url;
                } else {
                    // BEスキンの取得（Craftheadを利用：BE/Java両対応の強力なAPI）
                    avatarUrl = `https://crafthead.net/avatar/${cleanName}`;
                }
                document.getElementById('userAvatar').src = avatarUrl;


                // タブ生成
                renderTabs();
                // 初期タブ表示
                // データがある最初のゲームを選択
                const firstAvailable = Object.keys(GAMES).find(k => playerData[k] !== null) || 'wars';
                switchTab(firstAvailable);

                // UI表示
                document.getElementById('loader').style.display = 'none';
                document.getElementById('dashboard').style.display = 'block';

            } catch (e) {
                console.error(e);
                alert("プレイヤーが見つからないか、データがありません。\n統合版IDの場合は正確に入力してください。");
                document.getElementById('loader').style.display = 'none';
            }
        }

        // --- タブ描画 ---
        function renderTabs() {
            const container = document.getElementById('tabsContainer');
            container.innerHTML = '';
            
            Object.keys(GAMES).forEach(key => {
                // データがあるゲームだけタブを表示（あるいは全表示してdisableにするか。今回は全表示）
                const btn = document.createElement('button');
                btn.className = `tab-btn ${key === currentTab ? 'active' : ''}`;
                btn.innerText = GAMES[key].name;
                btn.onclick = () => switchTab(key);
                
                // データがない場合は薄くするなどの処理も可
                if (!playerData[key]) btn.style.opacity = '0.5';
                
                container.appendChild(btn);
            });
        }

        // --- タブ切り替え ---
        function switchTab(key) {
            currentTab = key;
            
            // タブのアクティブ表示更新
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
                if(btn.innerText === GAMES[key].name) btn.classList.add('active');
            });

            renderStats(key);
        }

        // --- 統計データ描画 (ここが本丸) ---
        function renderStats(key) {
            const container = document.getElementById('statsContent');
            const data = playerData[key];
            container.innerHTML = '';

            if (!data) {
                container.innerHTML = `<div style="grid-column:1/-1; text-align:center; padding:40px; color:var(--text-sub)">このゲームのプレイデータはありません。</div>`;
                return;
            }

            // --- 共通指標の計算 ---
            const played = data.played || 0;
            const victories = data.victories || 0;
            const kills = data.kills || 0;
            const deaths = data.deaths || 0;

            const winRate = played > 0 ? ((victories / played) * 100).toFixed(1) : 0;
            const kdRatio = deaths > 0 ? (kills / deaths).toFixed(2) : kills;

            // --- カード生成ヘルパー ---
            const addCard = (label, value, subText = null, styleClass = '') => {
                const div = document.createElement('div');
                div.className = `stat-card ${styleClass}`;
                
                let subHtml = '';
                if(subText) subHtml = `<div class="sub-value">${subText}</div>`;

                div.innerHTML = `
                    <span class="label">${label}</span>
                    <div class="value ${styleClass}">${value}</div>
                    ${subHtml}
                `;
                container.appendChild(div);
            };

            // --- メイン統計 (大きく表示) ---
            addCard("Victory Points", victories.toLocaleString(), `Win Rate: ${winRate}%`, "featured win");
            addCard("Total Kills", kills.toLocaleString(), `K/D Ratio: ${kdRatio}`, "featured kill");
            
            // --- 基本情報 ---
            addCard("Total Played", played.toLocaleString());
            addCard("Deaths", deaths.toLocaleString());
            if(data.xp) addCard("Experience", data.xp.toLocaleString(), "Total XP");
            if(data.prestige) addCard("Prestige", data.prestige, "周回数", "highlight");

            // --- ゲーム固有の詳細データ (APIにあるものは全部出す) ---
            
            // Treasure Wars
            if (key === 'wars') {
                if(data.final_kills) addCard("Final Kills", data.final_kills.toLocaleString(), "K/D計算対象外", "kill");
                if(data.treasure_destroyed) addCard("Treasures", data.treasure_destroyed.toLocaleString(), "破壊した宝");
            }
            // SkyWars
            if (key === 'sky') {
                if(data.mystery_chests_destroyed) addCard("Mystery Chests", data.mystery_chests_destroyed.toLocaleString());
                if(data.spells_used) addCard("Spells Used", data.spells_used.toLocaleString());
            }
            // DeathRun
            if (key === 'dr') {
                if(data.checkpoints) addCard("Checkpoints", data.checkpoints.toLocaleString());
                if(data.activated_traps) addCard("Traps Activated", data.activated_traps.toLocaleStri